pipeline {
    agent any

    environment {
        SERVICE_NAME    = "auth_service"
        DOCKER_IMAGE    = "storefront-${SERVICE_NAME}"
        DOCKER_REGISTRY = "tuan4886"
        TAG             = "${env.BUILD_NUMBER ?: 'dev'}"
        DOCKER_REPO     = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}" 
    }

    stages {
        stage('Test') {
            steps {
                echo 'Starting build and test for auth_service...'
                dir('auth_service') {
                    // Dọn container trước khi test
                    sh 'docker-compose -f docker-compose.auth.test.yml down -v'

                    // Build và chạy test, log kết quả rõ ràng
                    sh 'docker-compose -f docker-compose.auth.test.yml up --build --exit-code-from auth-service-test'
                    // Dọn sau test
                    sh 'docker-compose -f docker-compose.auth.test.yml down -v'
                }
            }
        }

        stage('Build Production Image') {
            steps {
                script {
                    echo "Building Production Image..."
                    sh "docker build --pull -t ${DOCKER_REPO}:${TAG} -f auth_service/Dockerfile ."
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "Pushing image to Docker Hub..."
                    withDockerRegistry(credentialsId: 'dockerhub-credentials', url: '') {
                        // Chỉ push với tag latest
                        sh "docker tag ${DOCKER_REPO}:${TAG} ${DOCKER_REPO}:latest"
                        sh "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        // Stage deploy sẽ thêm sau khi viết k3s manifest
    }

    post {
        always {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}